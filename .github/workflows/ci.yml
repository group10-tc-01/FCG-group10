name: CI Pipeline

on:
  pull_request:
    branches: [ "main", "develop" ]
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Cache .NET packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build solution
      run: dotnet build --no-restore --configuration Release

  unit-tests:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Restore and build (for tests)
      run: |
        dotnet restore
        dotnet build --configuration Release
    
    - name: Run unit tests with coverage
      run: |
        dotnet test tests/FCG.UnitTests \
          --configuration Release \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults/UnitTests \
          --logger trx \
          --verbosity normal
    
    - name: Debug unit test artifacts
      run: |
        echo "=== Unit Test Results Structure ==="
        ls -la ./TestResults/UnitTests/ || echo "No UnitTests directory"
        find ./TestResults -name "*.xml" -type f -exec ls -la {} \; || echo "No XML files found"
        find ./TestResults -name "*coverage*" -type f -exec ls -la {} \; || echo "No coverage files found"
    
    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: ./TestResults/

  integration-tests:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Restore and build (for tests)
      run: |
        dotnet restore
        dotnet build --configuration Release
    
    - name: Run integration tests with coverage
      run: |
        dotnet test tests/FCG.IntegratedTests \
          --configuration Release \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults/IntegrationTests \
          --logger trx \
          --verbosity normal
    
    - name: Debug integration test artifacts
      run: |
        echo "=== Integration Test Results Structure ==="
        ls -la ./TestResults/IntegrationTests/ || echo "No IntegrationTests directory"
        find ./TestResults -name "*.xml" -type f -exec ls -la {} \; || echo "No XML files found"
        find ./TestResults -name "*coverage*" -type f -exec ls -la {} \; || echo "No coverage files found"
    
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: ./TestResults/

  functional-tests:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Restore and build (for tests)
      run: |
        dotnet restore
        dotnet build --configuration Release
    
    - name: Run functional tests
      run: |
        dotnet test tests/FCG.FunctionalTests \
          --configuration Release \
          --logger trx \
          --verbosity normal
    
    - name: Upload functional test results
      uses: actions/upload-artifact@v4
      with:
        name: functional-test-results
        path: ./TestResults/

  coverage-analysis:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always() && (needs.unit-tests.result == 'success' || needs.integration-tests.result == 'success')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Install coverage tools
      run: dotnet tool install --global dotnet-reportgenerator-globaltool
    
    - name: Download unit test results
      uses: actions/download-artifact@v4
      with:
        name: unit-test-results
        path: ./TestResults-Unit/
      continue-on-error: true
    
    - name: Download integration test results
      uses: actions/download-artifact@v4
      with:
        name: integration-test-results  
        path: ./TestResults-Integration/
      continue-on-error: true
    
    - name: Debug downloaded artifacts
      run: |
        echo "=== All Downloaded Files ==="
        find . -name "*.xml" -type f -exec ls -la {} \; || echo "No XML files found"
        echo "=== Coverage Files Specifically ==="
        find . -name "*coverage*" -type f -exec ls -la {} \; || echo "No coverage files found"
        echo "=== Directory Structure ==="
        ls -laR ./TestResults-Unit/ || echo "No unit test results"
        ls -laR ./TestResults-Integration/ || echo "No integration test results"
    
    - name: Generate coverage reports
      run: |
        # Find all coverage files with multiple patterns
        coverage_files=""
        
        # Look for common coverage file patterns
        for pattern in "coverage.cobertura.xml" "coverage.opencover.xml" "*.coverage.xml" "*coverage*.xml"; do
          files=$(find . -name "$pattern" -type f 2>/dev/null || true)
          if [ ! -z "$files" ]; then
            echo "Found files with pattern $pattern:"
            echo "$files"
            coverage_files="$coverage_files $files"
          fi
        done
        
        if [ ! -z "$coverage_files" ]; then
          echo "Using coverage files: $coverage_files"
          reportgenerator \
            -reports:"$(echo $coverage_files | tr ' ' ';')" \
            -targetdir:"./CoverageReports" \
            -reporttypes:"Cobertura;OpenCover;HtmlInline_AzurePipelines" \
            -filefilters:"-**/tests/**;-**/FCG.UnitTests/**;-**/FCG.IntegratedTests/**;-**/FCG.FunctionalTests/**;-**/CommomTestsUtilities/**" \
            -classfilters:"-FCG.UnitTests.*;-FCG.IntegratedTests.*;-FCG.FunctionalTests.*;-*.Tests.*;-*TestsUtilities.*" \
            -verbosity:Info
        else
          echo "No coverage files found, checking if tests ran at all..."
          
          # Look for any .xml files that might be coverage files
          xml_files=$(find . -name "*.xml" -type f | grep -v "\.trx$" || true)
          
          if [ ! -z "$xml_files" ]; then
            echo "Found XML files that might be coverage files:"
            echo "$xml_files"
            
            # Try to generate report with all XML files
            reportgenerator \
              -reports:"$(echo $xml_files | tr ' \n' ';')" \
              -targetdir:"./CoverageReports" \
              -reporttypes:"Cobertura;OpenCover;HtmlInline_AzurePipelines" \
              -filefilters:"-**/tests/**;-**/FCG.UnitTests/**;-**/FCG.IntegratedTests/**;-**/FCG.FunctionalTests/**;-**/CommomTestsUtilities/**" \
              -classfilters:"-FCG.UnitTests.*;-FCG.IntegratedTests.*;-FCG.FunctionalTests.*;-*.Tests.*;-*TestsUtilities.*" \
              -verbosity:Info || echo "Failed to generate with XML files"
          fi
          
          # Fallback: create empty report
          mkdir -p ./CoverageReports
          echo '<?xml version="1.0" encoding="UTF-8"?><coverage line-rate="0" branch-rate="0" lines-covered="0" lines-valid="0" branches-covered="0" branches-valid="0" complexity="0" version="1.0" timestamp="0"></coverage>' > ./CoverageReports/Cobertura.xml
        fi
    
    - name: Parse coverage results
      id: coverage
      run: |
        if [ -f "./CoverageReports/Cobertura.xml" ]; then
          echo "=== Cobertura XML Content ==="
          cat ./CoverageReports/Cobertura.xml
          
          # Extract line coverage from Cobertura XML
          coverage=$(grep -o 'line-rate="[^"]*"' ./CoverageReports/Cobertura.xml | head -1 | cut -d'"' -f2 || echo "0")
          
          if [ ! -z "$coverage" ] && [ "$coverage" != "0" ]; then
            coverage_percent=$(echo "$coverage * 100" | bc -l | printf "%.0f" $(cat))
            echo "coverage_percent=$coverage_percent" >> $GITHUB_OUTPUT
            echo "Coverage: $coverage_percent%"
          else
            echo "coverage_percent=0" >> $GITHUB_OUTPUT
            echo "Coverage parsing resulted in 0% or failed"
          fi
        else
          echo "coverage_percent=0" >> $GITHUB_OUTPUT
          echo "Cobertura.xml file not found"
        fi
    
    - name: Check coverage threshold and comment
      if: github.event_name == 'pull_request'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COVERAGE_THRESHOLD: 80
      run: |
        coverage_percent=${{ steps.coverage.outputs.coverage_percent }}
        threshold=${COVERAGE_THRESHOLD:-80}
        
        if [ "$coverage_percent" -lt "$threshold" ]; then
          cat > comment.md << EOF
        ## ⚠️ Cobertura de Testes Abaixo do Esperado
        
        ![Alert GIF](https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExZWxqNTE4aGU3ZWk1NGVldTQ0eGcxMjlzN2NneGlpYzY1MjBmcHl0dSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/L8yQ0RQBItqso/giphy.gif)
        
        **Cobertura atual:** ${coverage_percent}%  
        **Cobertura mínima esperada:** ${threshold}%  
        **Diferença:** -$((threshold - coverage_percent))%
        
        Por favor, adicione mais testes para atingir a cobertura mínima antes de fazer o merge deste PR.
        
        ---
        *Este comentário foi gerado automaticamente pelo workflow de CI/CD*
        EOF
        
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
        else
          cat > comment.md << EOF
        ## ✅ Cobertura de Testes Aprovada
        
        ![Success GIF](https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif)
        
        **Cobertura atual:** ${coverage_percent}%  
        **Cobertura mínima esperada:** ${threshold}%  
        
        Excelente trabalho! A cobertura de testes está acima do threshold esperado.
        
        ---
        *Este comentário foi gerado automaticamente pelo workflow de CI/CD*
        EOF
        
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
        fi
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: ./CoverageReports/
    
    - name: Fail if coverage is below threshold
      if: steps.coverage.outputs.coverage_percent < 80
      run: |
        echo "Coverage ${{ steps.coverage.outputs.coverage_percent }}% is below the required threshold of 80%"
        exit 1

  sonar-analysis:
    runs-on: ubuntu-latest
    needs: [build, coverage-analysis]
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Restore and build for sonar
      run: |
        dotnet restore
        dotnet build --configuration Release
    
    - name: Download coverage reports
      uses: actions/download-artifact@v4
      with:
        name: coverage-reports
        path: ./CoverageReports/
      continue-on-error: true
    
    - name: Install SonarScanner
      run: dotnet tool install --global dotnet-sonarscanner
    
    - name: Begin SonarCloud analysis
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
      run: |
        dotnet sonarscanner begin \
          /k:"$SONAR_PROJECT_KEY" \
          /o:"$SONAR_ORGANIZATION" \
          /d:sonar.host.url="https://sonarcloud.io" \
          /d:sonar.token="$SONAR_TOKEN" \
          /d:sonar.cs.opencover.reportsPaths="./CoverageReports/OpenCover.xml" \
          /d:sonar.coverage.exclusions="**/tests/**,**/Migrations/**,**/Program.cs,**/Startup.cs,**/FunctionalTests/**,**/UnitTests/**,**/IntegratedTests/**,**/CommomTestsUtilities/**,**/*.Tests.*/**"
    
    - name: Build for SonarCloud
      run: dotnet build --configuration Release
    
    - name: End SonarCloud analysis
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: dotnet sonarscanner end /d:sonar.token="$SONAR_TOKEN"